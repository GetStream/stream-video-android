syntax = "proto3";

package stream.video.coordinator.client_v1_rpc;

import "google/protobuf/timestamp.proto";
import "video/coordinator/call_v1/call.proto";
import "video/coordinator/client_v1_rpc/envelopes.proto";
import "video/coordinator/edge_v1/edge.proto";
import "video/coordinator/push_v1/push.proto";
import "video/coordinator/stat_v1/stat.proto";
import "video/coordinator/utils_v1/utils.proto";

option go_package = "client_v1_rpc";
option java_outer_classname = "ClientV1RPC";
option csharp_namespace = "Stream.Video.v1.Coordinator";

service ClientRPC {
  //  rpc GetCall(GetCallRequest) returns (GetCallResponse);
  rpc CreateCall(CreateCallRequest) returns (CreateCallResponse);
  rpc GetOrCreateCall(GetOrCreateCallRequest) returns (GetOrCreateCallResponse);
  // JoinCall acts as GetOrCreateCall, but additionally returns list of datacenters to measure latency
  rpc JoinCall(JoinCallRequest) returns (JoinCallResponse);
  // GetCallSFU returns SFU information that is required to establish a connection
  rpc GetCallEdgeServer(GetCallEdgeServerRequest) returns (GetCallEdgeServerResponse);

  rpc UpdateCall(UpdateCallRequest) returns (UpdateCallResponse);

  // UpdateCallPermissions allows users to change permissions granted to members
  // this can be done in three ways:
  // 1. grant users a different role for this call (eg. make a host)
  // 2. grant users a permission on this call (eg. allow one user to screen-share)
  // 3. grant some permissions to all users (eg. allow participants to unmute themselves)
  rpc UpdateCallPermissions(UpdateCallPermissionsRequest) returns (UpdateCallPermissionsResponse);

  // EndCall sets the call as ended with the following side-effects:
  // the call itself is updated and ended_at set to current time
  // on-going call recording and broadcasting is stopped
  // all participants connected to the call are disconnected
  rpc EndCall(EndCallRequest) returns (EndCallResponse);

  rpc QueryCalls(QueryCallsRequest) returns (QueryCallsResponse);

  // QueryMembers gets a list of members that match your query criteria
  rpc QueryMembers(QueryMembersRequest) returns (QueryMembersResponse);

  rpc CreateDevice(CreateDeviceRequest) returns (CreateDeviceResponse);
  rpc DeleteDevice(DeleteDeviceRequest) returns (DeleteDeviceResponse);
  rpc QueryDevices(QueryDevicesRequest) returns (QueryDevicesResponse);

  // UNSTABLE ENDPOINTS BELOW

  // UpdateMembers creates or updates members in a room.

  // Adds members to a call
  rpc UpsertCallMembers(UpsertCallMembersRequest) returns (UpsertCallMembersResponse);
  // DeleteMembers deletes members from a room.
  rpc DeleteCallMembers(DeleteCallMembersRequest) returns (DeleteCallMembersResponse);

  rpc SendEvent(SendEventRequest) returns (SendEventResponse);

  rpc SendCustomEvent(SendCustomEventRequest) returns (SendCustomEventResponse);

  // room is a confusing name. better to call it breakout room
  // breakout rooms have their own audio/video track
  // breakout rooms have their own chat
  /**
  TODO
  rpc CreateBreakoutRoom(CreateBreakoutRoomRequest) returns (CreateBreakoutRoomResponse);
  rpc JoinBreakoutRoom() returns ();
  rpc LeaveBreakoutRoom() returns ();
  rpc DeleteBreakoutRoom() returns ();
  */

  // endpoint for storing stats (perhaps we should move this to the SFU layer though)
  rpc ReportCallStats(ReportCallStatsRequest) returns (ReportCallStatsResponse);
  // endpoint for storing stat-related events raised by the client
  rpc ReportCallStatEvent(ReportCallStatEventRequest) returns (ReportCallStatEventResponse);
  // endpoint for reviewing/rating the quality of calls
  rpc ReviewCall(ReviewCallRequest) returns (ReviewCallResponse);
  // endpoint for users to report issues with a call
  rpc ReportIssue(ReportIssueRequest) returns (ReportIssueResponse);
}

message GetCallRequest {
  string call_cid = 1;
}

message GetCallResponse {
  CallEnvelope call = 1;
}

message MemberInput {
  string user_id = 1;
  string role = 2;
  bytes custom_json = 3;
}

message UpsertCallMembersRequest {
  string call_cid = 1;
  repeated MemberInput members = 2;
  // Ringing option, used to signal to clients' UI
  bool ring = 3;
}

message UpsertCallMembersResponse {
}

message DeleteCallMembersRequest {
  string call_cid = 1;
  repeated string user_ids = 2;
}

message DeleteCallMembersResponse {
}

// A message that carries data for call creation
message CreateCallInput {
  // Call properties to set
  CallInput call = 1;
  // Members to add to the created call
  repeated MemberInput members = 2;
  // Ringing option, used to signal to clients' UI
  optional bool ring = 3;
}

// A request message for GetOrCreateCall endpoint
message CreateCallRequest {
  // Call type
  string type = 1;
  // Call ID. If empty, will be generated as UUIDv4
  optional string id = 2;
  // Call creation input, only used if the call does not exist
  CreateCallInput input = 3;
}

// A request message for GetOrCreateCall endpoint
message GetOrCreateCallRequest {
  // Call type
  string type = 1;
  // Call ID
  string id = 2;
  // Call creation input, only used if the call does not exist
  CreateCallInput input = 3;
}

// A request message for JoinCall endpoint
message JoinCallRequest {
  // Call type
  string type = 1;
  // Call ID
  string id = 2;
  // Call creation input, only used if the call does not exist
  CreateCallInput input = 3;
  // Preferred client datacenter. This is optional and when set, preferred datacenter selection is not guaranteed
  string datacenter_id = 4;
}

// A request message for GetOrCreateCall endpoint
message JoinCallResponse {
  CallEnvelope call = 1;
  // Whether a call was created
  bool created = 2;
  // A list of endpoints to measure latency
  repeated edge_v1.Edge edges = 3;
}

// Represents all updatable room fields
message CallInput {
  // Custom JSON object that is stored in this call
  // All users with read permissions will have access to this object
  bytes custom_json = 1;
  // Call options to set
  call_v1.CallOptions options = 2;
}

message GetOrCreateCallResponse {
  CallEnvelope call = 1;
  // Whether a call was created
  bool created = 2;
}

message UpdateCallRequest {
  string call_cid = 1;
  CallInput input = 2;
}

message UpdateCallResponse {
  CallEnvelope call = 1;
}

message RoleOverride {
  // the users that should get the new role, cannot be empty
  repeated string user_ids = 1;
  // the new role
  optional string role_name = 2;
}

message PermissionGrantOverride {
  // the users that will get the new permissions granted
  // if empty, the grant applies to all users
  repeated string user_ids = 1;
  // the list of permissions granted to users
  repeated string permissions = 2;
}

message UpdateCallPermissionsRequest {
  string call_cid = 1;
  oneof grant_input {
    RoleOverride role_override = 2;
    PermissionGrantOverride permission_override = 3;
  };
}

message UpdateCallPermissionsResponse {

}

message EndCallRequest {
  string call_cid = 1;
}

message EndCallResponse {

}

message CreateCallResponse {
  CallEnvelope call = 1;
}

message QueryCallsRequest {
  bytes mq_json = 1;
  optional int32 limit = 2;
  repeated utils_v1.Sort sorts = 3;
}

message QueryCallsResponse {
  CallsEnvelope calls = 1;
}

message QueryMembersRequest {
  bytes mq_json = 1;
  optional int32 limit = 2;
  repeated utils_v1.Sort sorts = 3;
}

message QueryMembersResponse {
  MembersEnvelope members = 1;
}

// A request message for GetCallEdgeServer endpoint
message GetCallEdgeServerRequest {
  // Call CID to get SFU for
  string call_cid = 1;
  // Latency measurement results
  // Optional
  edge_v1.LatencyMeasurements measurements = 2;
}

message GetCallEdgeServerResponse {
  CallEnvelope call = 1;
  // Call edge server credentials
  edge_v1.Credentials credentials = 2;
}

message CreateDeviceRequest {
  stream.video.coordinator.push_v1.DeviceInput input = 1;
}

message CreateDeviceResponse {
  stream.video.coordinator.push_v1.Device device = 1;
}

message DeleteDeviceRequest {
  string id = 1;
}

message DeleteDeviceResponse {
}

message QueryDevicesRequest {
}

message QueryDevicesResponse {
  repeated stream.video.coordinator.push_v1.Device devices = 1;
}

enum UserEventType {
  USER_EVENT_TYPE_UNSPECIFIED = 0;
  USER_EVENT_TYPE_ACCEPTED_CALL = 1;
  USER_EVENT_TYPE_REJECTED_CALL = 2;
  USER_EVENT_TYPE_CANCELLED_CALL = 3;
}

message SendEventRequest {
  // The call cid
  string call_cid = 1;
  // The type of event
  UserEventType event_type = 2;
}

message SendEventResponse {
}

message SendCustomEventRequest {
  // The call cid
  string call_cid = 1;
  // The type of event
  string type = 2;
  // The data of the event
  bytes data_json = 3;
}

message SendCustomEventResponse {
}

message ReportCallStatsRequest {
  // A concatenation of call type and call id with ":" as delimiter
  string call_cid = 1;
  // A WebRTC Stats report encoded as a JSON string, as defined in https://www.w3.org/TR/webrtc/#dom-rtcstatsreport
  bytes stats_json = 2;
}

message ReportCallStatsResponse {
}

message ReportCallStatEventRequest {
  // A concatenation of call type and call id with ":" as delimiter
  string call_cid = 1;

  // Event timestamp as RFC3339 string.
  google.protobuf.Timestamp timestamp = 2;

  oneof event {
    stat_v1.ParticipantConnected participant_connected = 3;
    stat_v1.ParticipantDisconnected participant_disconnected = 4;
    stat_v1.MediaStateChanged media_state_changed = 5;
  }
}

message ReportCallStatEventResponse {
}

message GetCallStatsRequest {
  // A concatenation of call type and call id with ":" as delimiter
  string call_cid = 1;
}

message ReportIssueRequest {
  // A concatenation of call type and call id with ":" as delimiter
  string call_cid = 1;

  // Optional description.
  string description = 2;

  bytes custom_json = 3;
}

message ReportIssueResponse {
}

message ReviewCallRequest {
  // A concatenation of call type and call id with ":" as delimiter
  string call_cid = 1;

  // Rating between 0 and 5 stars.
  float stars = 2;

  // Optional description.
  string description = 3;

  // Optional custom data.
  bytes custom_json = 4;
}

message ReviewCallResponse {
}
